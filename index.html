<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BLACK WEB </title>

<!-- Socket.IO client -->
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>

<!-- Geist Mono -->
<link rel="stylesheet" href="https://fonts.cdnfonts.com/css/geist-mono" />

<style>
  :root{
    --bg-900:#05040a;
    --bg-800:#071022;
    --purple-main:#6a2dd4;
    --accent:#9b6fff;
    --accent-strong:#caa6ff;
    --muted:#9aa6b2;
    --ok:#5eff9e;
    --danger:#ff3b3b;
    --glass: rgba(255,255,255,0.04);
  }
  .theme-purple{ --accent:#9b6fff; --accent-strong:#caa6ff; --ok:#8cffb4; }
  .theme-blue{ --accent:#2bb7ff; --accent-strong:#5ee1ff; --ok:#5eff9e; }
  .theme-green{ --accent:#4ee89a; --accent-strong:#7fffb7; --ok:#3ef08a; }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg-900),var(--bg-800));font-family:'Geist Mono',monospace,ui-monospace,SFMono-Regular,Menlo,monospace;color:var(--accent-strong);-webkit-font-smoothing:antialiased}
  button{font-family:inherit}
  a{color:inherit;text-decoration:none}

  /* canvas background */
  canvas#bg{position:fixed;inset:0;width:100%;height:100%;z-index:0;display:block}

  /* top ascii / glitch */
  .header{pointer-events:none;display:flex;align-items:center;justify-content:center;width:100%;max-width:1300px;margin:0 auto}
  pre.ascii{white-space:pre;line-height:0.78;font-weight:900;font-size:12px;text-align:center;filter:drop-shadow(0 18px 40px rgba(0,0,0,0.7));margin:0}
  @media(min-width:900px){ pre.ascii{font-size:16px} } @media(min-width:1400px){ pre.ascii{font-size:22px} }

  .layer{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);white-space:pre;text-align:center;pointer-events:none}
  .layer.top{color:var(--accent);mix-blend-mode:screen;filter:drop-shadow(0 6px 18px rgba(0,0,0,0.6));clip-path:polygon(0 0,100% 0,100% 28%,0 28%)}
  .layer.mid{color:rgba(255,255,255,0.98);font-weight:900;clip-path:polygon(0 30%,100% 30%,100% 72%,0 72%)}
  .layer.bot{color:var(--accent-strong);mix-blend-mode:screen;filter:blur(0.6px);clip-path:polygon(0 74%,100% 74%,100% 100%,0 100%)}
  @keyframes jitter{0%{transform:translate(-50%,-50%)}25%{transform:translate(calc(-50% - 2px),calc(-50% + 1px))}50%{transform:translate(calc(-50% + 2px),calc(-50% - 1px))}100%{transform:translate(-50%,-50%)}}
  .layer.top{animation:jitter 3.2s ease-in-out infinite}
  .layer.bot{animation:jitter 3.9s ease-in-out infinite}

  /* central app container */
  .app{position:relative;min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:18px;gap:12px;z-index:3}

  /* gate (poda) card */
  .gate{display:flex;flex-direction:column;align-items:center;gap:14px;padding:26px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.12));border:1px solid var(--glass);backdrop-filter:blur(6px);z-index:4;min-width:320px;max-width:92%}
  .gate small{color:var(--muted);font-size:13px}
  .pw{display:flex;gap:10px;align-items:center}
  .pw input{padding:14px 16px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--accent-strong);outline:none;min-width:260px;font-size:15px}
  .pw button{padding:12px 16px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent-strong));color:#001;cursor:pointer;font-weight:900;font-size:14px;letter-spacing:0.6px}

  .modal{position:fixed;left:50%;top:36%;transform:translate(-50%,-50%);min-width:340px;padding:16px;border-radius:12px;background:rgba(0,0,0,0.96);border:1px solid rgba(255,255,255,0.03);z-index:60;display:none}
  .modal.show{display:block}
  .modal .title{font-size:20px;font-weight:900;text-align:center}
  .modal.deny{border-color:var(--danger)}
  .modal.ok{border-color:var(--ok)}

  /* main chat UI */
  .chatWrap{position:fixed;inset:0;display:none;z-index:50;padding:18px}
  .chatWrap.visible{display:block}
  .chatPanel{height:100%;display:flex;flex-direction:column;border-radius:12px;background:linear-gradient(180deg,rgba(3,5,10,0.82),rgba(3,4,7,0.94));border:1px solid rgba(255,255,255,0.02);overflow:hidden;box-shadow:0 12px 40px rgba(0,0,0,0.6)}

  .topBar{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;border-bottom:1px solid rgba(255,255,255,0.02)}
  .topLeft{display:flex;align-items:center;gap:14px}
  .logo{display:flex;align-items:center;gap:10px}
  .sig{font-weight:900;letter-spacing:1px}
  .tagBox{background:linear-gradient(90deg,var(--accent),var(--accent-strong));padding:6px 12px;border-radius:8px;font-weight:800;color:#03030a;box-shadow:0 6px 18px rgba(0,0,0,0.45)}

  .topRight{display:flex;align-items:center;gap:8px}
  .iconBtn{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.14));border:1px solid rgba(255,255,255,0.03);cursor:pointer;color:var(--accent-strong)}
  .iconBtn svg{width:18px;height:18px}

  .chatBody{flex:1;display:flex;gap:14px;padding:18px;box-sizing:border-box}
  .mainCol{flex:1;display:flex;flex-direction:column;border-radius:10px;background:linear-gradient(180deg,rgba(0,0,0,0.32),rgba(0,0,0,0.24));padding:12px;min-width:0}
  .messages{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:12px}
  .msg{max-width:74%;padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.02);box-shadow:0 6px 18px rgba(11,18,30,0.25)}
  .msg.me{align-self:flex-end;background:linear-gradient(90deg,rgba(155,111,255,0.08),rgba(155,111,255,0.03));border:1px solid rgba(155,111,255,0.06)}
  .meta{font-size:12px;color:rgba(255,255,255,0.68);margin-bottom:8px}
  .composer{display:flex;gap:8px;padding:12px;border-top:1px dashed rgba(255,255,255,0.02);align-items:center}
  .composer input{flex:1;padding:12px;border-radius:12px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--accent-strong);outline:none;font-size:15px}
  .composer button{padding:12px 14px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent-strong));color:#001;cursor:pointer;font-weight:800}

  .membersBox{width:220px;border-radius:10px;padding:10px;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(0,0,0,0.06));border:1px solid rgba(255,255,255,0.02);min-height:100px}
  .membersTitle{font-weight:800;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between}
  .membersList{display:flex;flex-direction:column;gap:8px;max-height:60vh;overflow:auto}
  .memberItem{padding:6px 8px;border-radius:8px;background:transparent;color:rgba(255,255,255,0.9);font-size:13px;display:flex;align-items:center;justify-content:space-between}

  /* settings panel */
  .settings{position:fixed;right:18px;top:18px;width:320px;padding:12px;border-radius:10px;background:rgba(0,0,0,0.9);border:1px solid rgba(255,255,255,0.03);z-index:80;display:none}
  .settings.show{display:block}
  .themeDots{display:flex;gap:8px;margin-top:8px}
  .dot{width:38px;height:28px;border-radius:8px;cursor:pointer;border:2px solid rgba(255,255,255,0.04)}

  /* login modal */
  .loginCard{position:fixed;left:50%;top:52%;transform:translate(-50%,-50%);z-index:90;padding:28px;border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.6));border:1px solid rgba(255,255,255,0.04);backdrop-filter:blur(6px);min-width:360px;max-width:92%}
  .loginCard h1{margin:0 0 12px 0;font-size:20px}
  .loginRow{display:flex;gap:10px;align-items:center;margin-bottom:12px}
  .loginRow input{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--accent-strong);outline:none;font-size:15px}
  .adminBadge{background:linear-gradient(90deg,#ff6b6b,#ff3b3b);padding:4px 8px;border-radius:8px;font-weight:800;color:#fff;font-size:12px;margin-left:8px}

  /* top-right live indicator (blinking dot) */
  .topRightLive{display:flex;align-items:center;gap:8px;padding-left:6px}
  .dotLive{width:10px;height:10px;border-radius:999px;background:#ff4b4b;box-shadow:0 0 12px rgba(255,75,75,0.28);animation:blinkDot 1s infinite}
  @keyframes blinkDot{0%{opacity:1}50%{opacity:0.15}100%{opacity:1}}

  .status{position:fixed;right:12px;bottom:12px;padding:8px 12px;border-radius:8px;background:rgba(0,0,0,0.7);border:1px solid rgba(255,255,255,0.03);color:var(--muted);z-index:85;font-size:13px}

  @media(max-width:880px){
    .membersBox{display:none}
    .leftRail{display:none}
    .settings{right:8px;top:8px;width:260px}
    .loginCard{min-width:92%}
  }
</style>
</head>
<body class="theme-purple">

<canvas id="bg"></canvas>

<div class="app" id="app">
  <div class="header" id="header">
    <div style="position:relative;width:100%;max-width:1200px;display:flex;align-items:center;justify-content:center">
      <pre class="ascii" id="asciiBase">██╗    ██╗███████╗██╗      ██████╗ ██████╗ ███╗   ███╗███████╗
██║    ██║██╔════╝██║     ██╔════╝██╔═══██╗████╗ ████║██╔════╝
██║ █╗ ██║█████╗  ██║     ██║     ██║   ██║██╔████╔██║█████╗
██║███╗██║██╔══╝  ██║     ██║     ██║   ██║██║╚██╔╝██║██╔══╝
╚███╔███╔╝███████╗███████╗╚██████╗╚██████╔╝██║ ╚═╝ ██║███████╗
 ╚══╝╚══╝ ╚══════╝╚══════╝ ╚═════╝ ╚═════╝ ╚═╝     ╚═╝╚══════╝</pre>

      <div class="layer top" id="layerTop"></div>
      <div class="layer mid" id="layerMid"></div>
      <div class="layer bot" id="layerBot"></div>
    </div>
  </div>

  <div class="gate" id="gate">
    <small>Enter password to access</small>
    <div class="pw">
      <input id="pw" type="password" placeholder="password" autocomplete="off" />
      <button id="enterBtn" title="Enter">ENTER</button>
    </div>
  </div>
</div>

<div class="modal deny" id="denyModal"><div class="title">ACCESS DENIED</div></div>
<div class="modal ok" id="okModal"><div class="title">ACCESS GRANTED</div></div>

<!-- chat area -->
<div class="chatWrap" id="chatWrap" aria-hidden="true">
  <div class="chatPanel">
    <div class="topBar">
      <div class="topLeft">
        <div class="logo">
          <svg width="36" height="36" viewBox="0 0 24 24" fill="none"><rect x="2" y="2" width="20" height="20" rx="4" fill="currentColor" opacity="0.06"></rect><path d="M6 12h12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
          <div class="sig">BLACK WEB</div>
        </div>
        <div class="tagBox">#TAACPASANGA</div>
      </div>

      <div class="topRight">
        <div style="display:flex;align-items:center;gap:8px">
          <div class="topRightLive" title="Live"><div class="dotLive"></div><div style="font-weight:800;color:var(--muted)">LIVE</div></div>
          <button class="iconBtn" id="clearAllBtn" title="Clear chat (admin only)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" d="M3 6h18M8 6v12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V6"/></svg></button>
          <button class="iconBtn" id="settingsBtn" title="Settings"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" d="M12 15.5A3.5 3.5 0 1 0 12 8.5a3.5 3.5 0 0 0 0 7z"/><path stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.05.05a2 2 0 0 1-2.83 2.83l-.05-.05a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51"/></svg></button>
          <button class="iconBtn" id="logoutBtn" title="Logout"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg></button>
        </div>
      </div>
    </div>

    <div class="chatBody">
      <div class="mainCol">
        <div id="messages" class="messages"></div>
        <div class="composer">
          <input id="msgInput" placeholder="Type a message (Enter to send)" autocomplete="off" />
          <button id="sendBtn">Send</button>
        </div>
      </div>

      <div class="membersBox">
        <div class="membersTitle">Members <span style="opacity:0.7">(<span id="membersCountSmall">0</span>)</span></div>
        <div class="membersList" id="members"></div>
      </div>
    </div>
  </div>
</div>

<!-- settings panel -->
<div class="settings" id="settings" aria-hidden="true">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div style="font-weight:900">Settings</div>
    <button id="closeSettings" style="background:transparent;border:none;color:var(--muted);cursor:pointer">✕</button>
  </div>

  <div style="margin-top:12px;font-size:13px;color:var(--muted)">Theme</div>
  <div class="themeDots">
    <div class="dot" id="tPurple" title="Purple" style="background:linear-gradient(90deg,#9b6fff,#caa6ff)"></div>
    <div class="dot" id="tBlue" title="Blue" style="background:linear-gradient(90deg,#2bb7ff,#5ee1ff)"></div>
    <div class="dot" id="tGreen" title="Green" style="background:linear-gradient(90deg,#4ee89a,#7fffb7)"></div>
  </div>

  <div style="margin-top:14px;display:flex;gap:8px">
    <button id="clearLocal" style="flex:1;padding:10px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.04);cursor:pointer">Clear local</button>
    <button id="clearAsk" style="flex:1;padding:10px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.04);cursor:pointer">Clear (admin)</button>
  </div>

  <div style="margin-top:12px">
    <button id="logoutBtn2" style="padding:10px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.04);cursor:pointer">Logout</button>
  </div>
</div>

<!-- login card (username + password) -->
<div id="loginCard" class="loginCard" style="display:none;z-index:100">
  <h1>Sign in to BLACK WEB</h1>
  <div style="color:var(--muted);margin-bottom:12px">Enter your username and password. To become admin, provide the admin secret.</div>
  <div class="loginRow">
    <input id="loginUser" placeholder="Username" autocomplete="username" />
  </div>
  <div class="loginRow">
    <input id="loginPass" placeholder="Password" type="password" autocomplete="current-password" />
  </div>
  <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
    <button id="cancelLogin" style="padding:10px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.04);cursor:pointer">Cancel</button>
    <button id="doLogin" style="padding:10px;border-radius:10px;background:linear-gradient(90deg,var(--accent),var(--accent-strong));border:none;color:#001;cursor:pointer;font-weight:800">Login</button>
  </div>
  <div id="loginErr" style="color:#ff8a8a;margin-top:10px;display:none"></div>
</div>

<div class="status" id="status">Idle</div>

<script>
/* ===== CONFIG ===== */
const SERVER_URL = 'https://server-81ja.onrender.com';
const PASS = 'poda'; // gate passphrase
const ADMIN_SECRET = '2704zoro'; // admin secret, case-insensitive
/* =================== */

const asciiBase = document.getElementById('asciiBase').textContent;
document.getElementById('layerTop').textContent = asciiBase;
document.getElementById('layerMid').textContent = asciiBase;
document.getElementById('layerBot').textContent = asciiBase;

/* UI refs */
const enterBtn = document.getElementById('enterBtn'), pwInput = document.getElementById('pw');
const denyModal = document.getElementById('denyModal'), okModal = document.getElementById('okModal');
const gate = document.getElementById('gate'), header = document.getElementById('header');

const chatWrap = document.getElementById('chatWrap'), messagesEl = document.getElementById('messages');
const membersEl = document.getElementById('members'), membersCountSmall = document.getElementById('membersCountSmall'), memberCount = document.getElementById('memberCount');
const msgInput = document.getElementById('msgInput'), sendBtn = document.getElementById('sendBtn');

const settingsBtn = document.getElementById('settingsBtn'), settingsPanel = document.getElementById('settings');
const tPurple = document.getElementById('tPurple'), tBlue = document.getElementById('tBlue'), tGreen = document.getElementById('tGreen');
const closeSettings = document.getElementById('closeSettings'), clearLocal = document.getElementById('clearLocal'), clearAsk = document.getElementById('clearAsk');
const clearAllBtn = document.getElementById('clearAllBtn');
const logoutBtn = document.getElementById('logoutBtn'), logoutBtn2 = document.getElementById('logoutBtn2');
const loginCard = document.getElementById('loginCard'), loginUser = document.getElementById('loginUser'), loginPass = document.getElementById('loginPass');
const cancelLogin = document.getElementById('cancelLogin'), doLogin = document.getElementById('doLogin'), loginErr = document.getElementById('loginErr');
const statusEl = document.getElementById('status');
const liveIndicator = document.querySelector('.topRightLive');

let socket = null;
let username = localStorage.getItem('bw_username') || null;
let passwordStored = localStorage.getItem('bw_password') || null; // local only
let isAdmin = (localStorage.getItem('bw_is_admin') === '1');
let members = {}; // nick -> { id, lastSeen, conflict }
const seenMsgIds = new Set();

/* Canvas background (dots) */
const canvas = document.getElementById('bg'), ctx = canvas.getContext('2d');
let W = canvas.width = innerWidth, H = canvas.height = innerHeight;
window.addEventListener('resize', ()=>{ W = canvas.width = innerWidth; H = canvas.height = innerHeight; initDots(); });

let dots = [], mouse = {x:-9999,y:-9999};
function initDots(){ dots=[]; const N = Math.max(40, Math.floor((W*H)/90000)); for(let i=0;i<N;i++) dots.push({x:Math.random()*W,y:Math.random()*H,vx:(Math.random()-0.5)*0.45,vy:(Math.random()-0.5)*0.45,r:Math.random()*1.6+0.6}); }
initDots();
window.addEventListener('mousemove', e=>{ mouse.x = e.clientX; mouse.y = e.clientY; });
window.addEventListener('mouseleave', ()=>{ mouse.x = -9999; mouse.y = -9999; });

function drawBg(){ ctx.clearRect(0,0,W,H); ctx.fillStyle='rgba(3,4,8,0.09)'; ctx.fillRect(0,0,W,H);
  for(const p of dots){ p.x += p.vx; p.y += p.vy; if(p.x<0||p.x>W) p.vx*=-1; if(p.y<0||p.y>H) p.vy*=-1; const dx=mouse.x-p.x, dy=mouse.y-p.y, d2=dx*dx+dy*dy; if(d2<20000){ p.vx += dx*0.00008; p.vy += dy*0.00008; } }
  for(let i=0;i<dots.length;i++){ const a = dots[i]; for(let j=i+1;j<dots.length;j++){ const b=dots[j]; const d=Math.hypot(a.x-b.x,a.y-b.y); if(d<120){ const alpha=1-d/120; ctx.strokeStyle='rgba(155,111,255,'+(alpha*0.06)+')'; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke(); } } }
  for(const p of dots){ const d=Math.hypot(p.x-mouse.x,p.y-mouse.y); if(d<160){ const a=1-d/160; ctx.strokeStyle='rgba(94,225,255,'+(a*0.12)+')'; ctx.beginPath(); ctx.moveTo(p.x,p.y); ctx.lineTo(mouse.x,mouse.y); ctx.stroke(); } }
  for(const p of dots){ ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--accent-strong').trim() || '#caa6ff'; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill(); }
  requestAnimationFrame(drawBg);
}
drawBg();

/* Gate logic (poda) */
enterBtn.addEventListener('click', tryPass);
pwInput.addEventListener('keyup', e => { if(e.key === 'Enter') tryPass(); });

function tryPass(){
  const v = (pwInput.value||'').trim();
  if(!v) return;
  if(v.toLowerCase() === PASS.toLowerCase()){
    showOk();
  } else {
    showDenied();
  }
}
function showDenied(){
  denyModal.classList.add('show','blink');
  setTimeout(()=> denyModal.classList.remove('blink'), 1200);
  setTimeout(()=> denyModal.classList.remove('show'), 1600);
  pwInput.value=''; pwInput.placeholder='wrong passphrase';
  navigator.vibrate?.(50);
}
function showOk(){
  okModal.classList.add('show','blink');
  setTimeout(()=> okModal.classList.remove('blink'), 1200);
  setTimeout(()=> { okModal.classList.remove('show'); connectSocket(); }, 1200);
}

/* Socket connect + handlers */
function setStatus(s){ statusEl.textContent = s; }
function showLive(){ liveIndicator.style.display='flex'; }
function hideLive(){ liveIndicator.style.display='none'; }

function connectSocket(){
  setStatus('Connecting to server...');
  try {
    socket = io(SERVER_URL, { transports:['websocket'], secure:true, reconnectionAttempts: 6 });
  } catch(e) {
    console.error(e); setStatus('Socket init error');
    return;
  }

  socket.on('connect', ()=>{ setStatus('Connected'); showLive(); startLoginFlow(); });

  socket.on('disconnect', ()=>{ setStatus('Disconnected'); hideLive(); });

  socket.on('connect_error', (err)=>{ setStatus('Connect error'); console.error(err); });

  socket.on('message', payload => {
    if(!payload) return;
    if(payload.msgId && seenMsgIds.has(payload.msgId)) return;
    if(payload.msgId) seenMsgIds.add(payload.msgId);

    if(payload.type === 'presence'){ handlePresence(payload); return; }
    if(payload.type === 'chat'){ appendMessage(payload.from, payload.text, payload.t); return; }
    if(payload.type === 'clear'){ // server rebroadcasts clear
      if(payload.admin){ messagesEl.innerHTML=''; appendSystem(`${payload.by} cleared the chat (admin)`); }
      else appendSystem('Chat cleared by request (not admin)');
      return;
    }
    if(payload.from && payload.text){ appendMessage(payload.from, payload.text, payload.t || Date.now()); }
  });
}

/* Presence / members */
function handlePresence(p){
  const nick = (p.nick||'').trim();
  if(!nick) return;
  if(p.action === 'join'){
    if(members[nick] && members[nick].id !== p.id) members[nick].conflict = true;
    else members[nick] = { id: p.id, lastSeen: Date.now(), conflict: false };
    renderMembers();
    // conflict with local username
    if(username && username.toLowerCase() === nick.toLowerCase() && members[nick].id !== socket.id){
      alert('Nickname collision detected — your username is in use elsewhere. You will be signed out.');
      doLogout();
    }
  } else if(p.action === 'leave'){
    if(members[nick] && members[nick].id === p.id) delete members[nick];
    renderMembers();
  }
}

function broadcastPresence(action, nick){
  if(!socket || !socket.connected) return;
  const payload = { type:'presence', action, nick, id: socket.id, t: Date.now(), msgId: 'p-'+Date.now()+'-'+Math.random().toString(36).slice(2,6) };
  socket.emit('message', payload);
  if(action === 'join') members[nick] = { id: socket.id, lastSeen: Date.now(), conflict:false };
  if(action === 'leave' && members[nick]) delete members[nick];
  renderMembers();
}

/* Claim username (check locally via presence and members map) */
function tryClaimUsername(name){
  return new Promise(resolve => {
    if(Object.keys(members).some(n => n.toLowerCase() === name.toLowerCase())) return resolve(false);
    const id = socket ? socket.id : ('loc-'+Math.random().toString(36).slice(2,8));
    const payload = { type:'presence', action:'join', nick: name, id, t: Date.now(), msgId: 'p-'+Date.now()+'-'+Math.random().toString(36).slice(2,6) };
    if(socket && socket.connected) socket.emit('message', payload);
    const start = Date.now(); let conflict=false;
    const check = setInterval(()=> {
      if(Object.keys(members).some(n => n.toLowerCase()===name.toLowerCase() && members[n].id !== id)) conflict=true;
      if(Date.now()-start > 650){ clearInterval(check); resolve(!conflict); }
    }, 120);
  });
}

/* Login flow (show login card) */
function startLoginFlow(){
  header.style.display='none'; gate.style.display='none';
  // If username stored, attempt to claim; but per your request, require login each time after gate (so show login card every time)
  showLoginCard();
}

function showLoginCard(){
  loginCard.style.display = 'block';
  loginUser.value = username || '';
  loginPass.value = '';
  loginUser.focus();
}

document.getElementById('cancelLogin').addEventListener('click', ()=> {
  loginCard.style.display = 'none';
  header.style.display=''; gate.style.display='';
  if(socket) socket.disconnect();
  setStatus('Login cancelled');
});

doLogin.addEventListener('click', async () => {
  const user = (loginUser.value||'').trim();
  const pass = (loginPass.value||'').trim();
  if(!user){ loginErr.textContent='Enter username'; loginErr.style.display='block'; return; }
  loginErr.style.display='none';
  const ok = await tryClaimUsername(user);
  if(!ok){ loginErr.textContent='Username already in use'; loginErr.style.display='block'; return; }
  // admin detection
  const adminFlag = pass && pass.toLowerCase() === ADMIN_SECRET.toLowerCase();
  if(adminFlag) { isAdmin = true; localStorage.setItem('bw_is_admin','1'); } else { isAdmin = false; localStorage.removeItem('bw_is_admin'); }
  // store username & password locally (password is local-only)
  username = user;
  localStorage.setItem('bw_username', username);
  if(pass) localStorage.setItem('bw_password', pass); else localStorage.removeItem('bw_password');
  // close login card and enter chat
  loginCard.style.display = 'none';
  enterChat();
});

loginPass.addEventListener('keyup', e => { if(e.key === 'Enter') doLogin.click(); });
loginUser.addEventListener('keyup', e => { if(e.key === 'Enter') doLogin.click(); });

/* Enter chat (after successful login) */
function enterChat(){
  chatWrap.classList.add('visible');
  broadcastPresence('join', username);
  setStatus('Connected — live');
  if(isAdmin) appendSystem('You are signed in as ADMIN');
}

/* Messages handling: 12-hour format */
function formatTime12(ts){
  const d = new Date(ts || Date.now());
  let h = d.getHours(); const ampm = h >= 12 ? 'PM' : 'AM';
  h = h % 12; if(h === 0) h = 12;
  const mm = d.getMinutes().toString().padStart(2,'0');
  return `${h}:${mm} ${ampm}`;
}

function appendMessage(from, text, ts){
  const id = (ts||Date.now()) + '|' + (text||'').slice(0,90) + '|' + from;
  if(seenMsgIds.has(id)) return;
  seenMsgIds.add(id);
  const el = document.createElement('div');
  el.className = 'msg' + ((username && username === from) ? ' me' : '');
  const time = formatTime12(ts);
  const meta = `<div class="meta">${escapeHtml(from)} · ${time}${ isAdmin && from === username ? ' <span class="adminBadge">ADMIN</span>' : '' }</div>`;
  el.innerHTML = meta + `<div>${escapeHtml(text)}</div>`;
  messagesEl.appendChild(el);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function appendSystem(text){
  const el = document.createElement('div'); el.style.textAlign='center'; el.style.opacity=0.9; el.style.margin='6px 0'; el.style.fontSize='13px'; el.textContent = text;
  messagesEl.appendChild(el);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

/* Send message */
sendBtn.addEventListener('click', sendMessage);
msgInput.addEventListener('keyup', e => { if(e.key === 'Enter') sendMessage(); });

function sendMessage(){
  const txt = (msgInput.value||'').trim(); if(!txt) return;
  if(!username){ alert('You must login first'); return; }
  const msgId = 'm-'+Date.now()+'-'+Math.random().toString(36).slice(2,8);
  const payload = { type:'chat', from: username, text: txt, t: Date.now(), msgId };
  if(socket && socket.connected) socket.emit('message', payload);
  // optimistic append and dedupe
  seenMsgIds.add(payload.msgId);
  appendMessage(username, txt, payload.t);
  msgInput.value = '';
}

/* Render members */
function renderMembers(){
  membersEl.innerHTML = '';
  const keys = Object.keys(members);
  keys.forEach(n => {
    const meta = members[n];
    const div = document.createElement('div');
    div.className = 'memberItem';
    div.innerHTML = `<div>${escapeHtml(n)}${ n===username ? ' <span style="opacity:0.7">• you</span>' : '' }</div><div style="opacity:0.6">${meta && meta.conflict ? '⚠' : ''}</div>`;
    membersEl.appendChild(div);
  });
  membersCountSmall.textContent = keys.length;
  memberCount.textContent = keys.length;
}

/* Logout */
function doLogout(){
  if(username && socket && socket.connected) socket.emit('message', { type:'presence', action:'leave', nick: username, id: socket.id, t: Date.now(), msgId: 'p-'+Date.now()+'-'+Math.random().toString(36).slice(2,6) });
  localStorage.removeItem('bw_username'); localStorage.removeItem('bw_password'); localStorage.removeItem('bw_is_admin');
  username = null; isAdmin = false;
  if(socket) socket.disconnect();
  setTimeout(()=> location.reload(), 150);
}
logoutBtn.addEventListener('click', doLogout);
logoutBtn2.addEventListener('click', doLogout);

/* Settings open/close */
settingsBtn.addEventListener('click', ()=> settingsPanel.classList.toggle('show'));
closeSettings.addEventListener('click', ()=> settingsPanel.classList.remove('show'));

// close when clicking outside settings
document.addEventListener('click', (e) => {
  const inside = e.target.closest('.settings') || e.target.closest('#settingsBtn') || e.target.closest('#clearAllBtn');
  if(!inside) settingsPanel.classList.remove('show');
});

/* Theme pick */
tPurple.addEventListener('click', ()=> { document.body.classList.remove('theme-blue','theme-green'); document.body.classList.add('theme-purple'); localStorage.setItem('bw_theme','purple'); });
tBlue.addEventListener('click', ()=> { document.body.classList.remove('theme-purple','theme-green'); document.body.classList.add('theme-blue'); localStorage.setItem('bw_theme','blue'); });
tGreen.addEventListener('click', ()=> { document.body.classList.remove('theme-purple','theme-blue'); document.body.classList.add('theme-green'); localStorage.setItem('bw_theme','green'); });

(function applyTheme(){ const t = localStorage.getItem('bw_theme') || 'purple'; document.body.classList.remove('theme-purple','theme-blue','theme-green'); document.body.classList.add(t==='blue'?'theme-blue':(t==='green'?'theme-green':'theme-purple')); })();

/* Clear local messages */
clearLocal.addEventListener('click', ()=> { if(confirm('Clear local messages? (server copy remains)')) messagesEl.innerHTML=''; });

/* Clear for everyone (admin only). If not admin, prompt for secret; admin sends clear payload */
clearAsk.addEventListener('click', ()=> {
  if(isAdmin){ if(confirm('Clear chat for everyone?')) doClearAll(); return; }
  const pw = prompt('Admin secret to clear chat for everyone (leave blank to cancel):');
  if(!pw) return;
  if(pw.trim().toLowerCase() === ADMIN_SECRET.toLowerCase()){
    localStorage.setItem('bw_is_admin','1'); isAdmin = true; doClearAll();
  } else alert('Incorrect admin secret');
});

clearAllBtn.addEventListener('click', ()=> {
  if(isAdmin){ if(confirm('Clear chat for everyone?')) doClearAll(); return; }
  const pw = prompt('Admin secret to clear chat for everyone:');
  if(!pw) return;
  if(pw.trim().toLowerCase() === ADMIN_SECRET.toLowerCase()){
    localStorage.setItem('bw_is_admin','1'); isAdmin = true; doClearAll();
  } else alert('Incorrect admin secret');
});

function doClearAll(){
  if(!socket || !socket.connected){ alert('Not connected'); return; }
  const payload = { type:'clear', by: username || 'unknown', admin: true, t: Date.now(), msgId: 'c-'+Date.now()+'-'+Math.random().toString(36).slice(2,6) };
  socket.emit('message', payload);
  messagesEl.innerHTML=''; appendSystem(`${username} cleared the chat (admin)`);
}

/* Graceful leave on unload */
window.addEventListener('beforeunload', ()=> {
  if(socket && socket.connected && username){
    socket.emit('message', { type:'presence', action:'leave', nick: username, id: socket.id, t: Date.now(), msgId: 'p-'+Date.now()+'-'+Math.random().toString(36).slice(2,6) });
  }
});

/* small helpers */
function setStatus(s){ statusEl.textContent = s; }

/* start connection when page loaded and gate passed */
(function init(){
  // UI initial states
  loginCard.style.display = 'none';
  document.querySelector('.topRightLive').style.display = 'none';
  // we wait for user to enter gate pass; connectSocket triggered then
})();

/* Expose for debugging */
window._debug = { connectSocket: connectSocket, doLogout: doLogout };

</script>
</body>
</html>


